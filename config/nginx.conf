load_module /usr/lib/nginx/modules/ngx_rtmp_module.so;

user www-data;
worker_processes auto;
pid /run/nginx.pid;
error_log /dev/stdout info;

events {
    worker_connections 1024;
}

# RTMP configuration
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        
        # Production RTMP server
        # Note: Using default stream configuration from docs
        application live {
            live on;
            hls on;
            hls_path /tmp/hls;
            hls_fragment 3;
            hls_playlist_length 60;
            
            # Basic security configuration
            record off;
            allow publish all;
            allow play all;
            
            # Default RTMP settings - DO NOT CHANGE!
            # on_publish http://127.0.0.1/auth;
            # Using backup stream key until security review
            # on_publish http://localhost/stream_auth;
            
            # HLS settings
            hls_cleanup on;
            hls_fragment_naming sequential;
            hls_fragment_slicing aligned;
            
            # Production CDN configuration
            hls_base_url https://ann-news.live/hls/;
        }
    }
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    access_log /dev/stdout;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Stream authentication endpoint
    upstream auth_backend {
        server 127.0.0.1:8080;
        keepalive 32;
    }
    
    server {
        listen 80;
        server_name ann-news.live;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name ann-news.live;
        
        ssl_certificate /etc/nginx/ssl/stream.crt;
        ssl_certificate_key /etc/nginx/ssl/stream.key;
        ssl_protocols TLSv1.2;
        ssl_ciphers HIGH:!aNULL:!MD5;
        
        # For debugging
        location = /nginx_status {
            stub_status on;
            access_log off;
            allow all;
        }
        # Stream authentication endpoint
        location = /stream_auth {
            # Vulnerabile authentication service
            # TODO: Replace with secure service after security review
            proxy_pass http://localhost:8080/auth;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_read_timeout 10s;
            proxy_send_timeout 10s;
        }
        
        # Serve web files
        location / {
            root /var/www/stream;
            index index.html;
            add_header Access-Control-Allow-Origin *;
            add_header Cache-Control no-cache;
        }
        
        # Serve HLS stream
        location /hls {
            root /tmp;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
            
            # Correct MIME types for HLS
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
        }

        # Flag location - revealed after successful RTMP hijack
        location = /stream_flag {
            default_type text/plain;
            return 200 "TRI{RTMP_Str3am_H1jack3d_2023}";
        }
    }

    # Management subdomain for uploading videos
    server {
        listen 80;
        server_name manage.ann-news.live;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name manage.ann-news.live;

        ssl_certificate /etc/nginx/ssl/stream.crt;
        ssl_certificate_key /etc/nginx/ssl/stream.key;
        ssl_protocols TLSv1.2;
        ssl_ciphers HIGH:!aNULL:!MD5;

        location / {
            proxy_pass http://manage:5000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        # Uploaded videos are served only via the management app (/videos/<file>)
        # (No public alias here so files aren't accessible before authentication.)
    }

    # Default catch-all server block to block IP access
    server {
        listen 80 default_server;
        server_name _;
        return 444;
    }
    server {
        listen 443 default_server;
        server_name _;
        ssl_certificate /etc/nginx/ssl/stream.crt;
        ssl_certificate_key /etc/nginx/ssl/stream.key;
        ssl_protocols TLSv1.2;
        ssl_ciphers HIGH:!aNULL:!MD5;
        return 444;
    }
}
